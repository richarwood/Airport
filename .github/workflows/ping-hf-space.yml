name: Keep Hugging Face Space Awake (random daily)

on:
  schedule:
    # run hourly and let the job pick a random hour once per day
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  ping-space:
    runs-on: ubuntu-latest
    steps:
      - name: Set UTC date and hour
        run: |
          echo "DATE=$(date -u +%F)" >> $GITHUB_ENV
          echo "HOUR=$(date -u +%H)" >> $GITHUB_ENV

      - name: Restore daily marker cache
        uses: actions/cache@v4
        with:
          path: .hf-ping-marker
          key: hf-ping-${{ env.DATE }}

      - name: Decide whether to run today
        env:
          DATE: ${{ env.DATE }}
          HOUR: ${{ env.HOUR }}
        run: |
          if [ -f .hf-ping-marker/ran ]; then
            echo "Already ran today (${DATE}); exiting."
            exit 0
          fi
          RANDOM_HOUR=$(( ( RANDOM ) % 24 ))
          echo "Random hour selected: $RANDOM_HOUR; current UTC hour: $HOUR"
          if [ "$RANDOM_HOUR" -ne "$HOUR" ]; then
            echo "Not the selected hour; exiting."
            exit 0
          fi
          echo "Selected hour matches, proceeding to ping."

      - name: Ping Hugging Face Space
        env:
          SPACE_URL: "https://huggingface.co/spaces/richarwood/airport"
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          echo "Pinging $SPACE_URL"
          if [ -n "$HF_TOKEN" ]; then
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -L --max-time 30 -A "github-action-pinger/1.0" -H "Authorization: Bearer $HF_TOKEN" "$SPACE_URL")
          else
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -L --max-time 30 -A "github-action-pinger/1.0" "$SPACE_URL")
          fi
          echo "HTTP status: $HTTP_STATUS"
          echo "HTTP_STATUS=$HTTP_STATUS" >> $GITHUB_ENV
          if [ "$HTTP_STATUS" -eq 200 ]; then
            mkdir -p .hf-ping-marker
            echo "ran" > .hf-ping-marker/ran
            echo "Ping succeeded; marker written."
            exit 0
          else
            echo "Ping failed with status $HTTP_STATUS"
            exit 2
          fi

      - name: Save daily marker cache
        if: success()
        uses: actions/cache@v4
        with:
          path: .hf-ping-marker
          key: hf-ping-${{ env.DATE }}

      - name: Send email on failure
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "Hugging Face Space ping failed for richarwood/airport (status ${{ env.HTTP_STATUS }})"
          body: |
            The scheduled ping of https://huggingface.co/spaces/richarwood/airport failed.
            Run: ${{ github.run_url }}
            HTTP status: ${{ env.HTTP_STATUS }}
          to: ${{ secrets.EMAIL_TO }}
          from: ${{ secrets.EMAIL_FROM }}
          secure: true

# NOTES:
# - 该 workflow 每小时触发一次（UTC），脚本在每个 UTC 日期里随机选一个小时执行一次实际 ping（通过 cache 标记当天已执行，避免同一天多次执行）。
# - 若 ping 返回 200，则写入当天 marker 并退出成功；如果非 200，则 job 失败并进入邮件通知步骤。
# - 需要在仓库 Settings → Secrets 添加以下 secret：
#   - HF_TOKEN (可选，仅当 space 为私有时需要)
#   - SMTP_HOST (例如 smtp.gmail.com)
#   - SMTP_PORT (例如 587)
#   - SMTP_USERNAME
#   - SMTP_PASSWORD
#   - EMAIL_TO (接收通知的邮箱)
#   - EMAIL_FROM (发件地址，部分 SMTP 需要与 username 一致)
# - 如果你不想使用 SMTP，可以把最后发送邮件步骤替换为调用一个邮件 API（SendGrid/Mailgun）或发送到通知渠道（Webhook/Slack 等）。
